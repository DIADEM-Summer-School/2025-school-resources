Bootstrap: docker
From: ubuntu:24.04
Stage: devel

%files

# Install build tools and some needed dependencies  
# apt-get is the package manager (i.e : most commonly used tool to install software) 
# of debian and all debian-based distribution (such as Ubuntu) 
%post -c /bin/bash
    apt-get -u update
    apt-get install -y wget gnupg2 bash gcc meson ninja-build git
    
    # --------------     INTEL COMPILERS     -------------- #
    # This part append intel repository to our list of downloadable software
    # then install required compilers and libraries
    mkdir -p /etc/apt/keyrings
    wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor > /etc/apt/keyrings/intel-sw-products.gpg
    echo "deb [signed-by=/etc/apt/keyrings/intel-sw-products.gpg] https://apt.repos.intel.com/oneapi all main" > /etc/apt/sources.list.d/oneAPI.list
    apt-get -y update
    apt-get -y install intel-oneapi-compiler-fortran intel-oneapi-compiler-dpcpp-cpp intel-oneapi-mkl
    source /opt/intel/oneapi/setvars.sh intel64
    # ----------------------------------------------------- #

    # --------------     GNU COMPILERS       -------------- #
    # install open source alternatives
    # apt-get install -y ...
    # ----------------------------------------------------- #   

    # Download the source code
    cd /opt
    wget https://github.com/grimme-lab/xtb/archive/refs/tags/bleed.tar.gz --no-check-certificate
    tar -xf bleed.tar.gz
    cd xtb-bleed

    # set env variable
    # Check xtb documentation to see what need to be modified here
    export FC=ifx
    export CC=icx
    export GIT_SSL_NO_VERIFY=1
    meson setup build --buildtype=release 

    ninja -C build

Bootstrap: docker
From: ubuntu:24.04
Stage: final

%files from devel
    /opt/xtb-bleed/build/ /opt/xtb-bleed/build/
    /opt/intel/oneapi/compiler/2025.2/lib/libifcore.so.5  /opt/intel/lib/libifcore.so.5
    /opt/intel/oneapi/mkl/latest/lib/libmkl_intel_lp64.so.2  /opt/intel/lib/libmkl_intel_lp64.so.2
    /opt/intel/oneapi/mkl/latest/lib/libmkl_intel_thread.so.2  /opt/intel/lib/libmkl_intel_thread.so.2
    /opt/intel/oneapi/mkl/latest/lib/libmkl_core.so.2  /opt/intel/lib/libmkl_core.so.2
    /opt/intel/oneapi/mkl/2025.2/lib/libmkl_avx2.so.2  /opt/intel/lib/libmkl_avx2.so.2
    /opt/intel/oneapi/mkl/2025.2/lib/libmkl_def.so.2  /opt/intel/lib/libmkl_def.so.2
    /opt/intel/oneapi/compiler/2025.2/lib/libimf.so  /opt/intel/lib/libimf.so
    /opt/intel/oneapi/compiler/2025.2/lib/libiomp5.so  /opt/intel/lib/libiomp5.so
    /opt/intel/oneapi/compiler/2025.2/lib/libsvml.so  /opt/intel/lib/libsvml.so
    /opt/intel/oneapi/compiler/2025.2/lib/libintlc.so.5  /opt/intel/lib/libintlc.so.5

%environment
  export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:/opt/intel/lib/"

%runscript
    /opt/xtb-bleed/build/xtb $*
